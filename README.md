# AWS Serverless: Subscription (Stripe) - Register - DynamoDB - Login
## Summary
This project builds a subscription website with AWS and Stripe. It allows users to register, verify email addresses, login, and reset password by using AWS Cognito. A webpage with 3 tiers of subscription plans and 3 corresponding buttons will be presented to the user. The 3 subscription plans are linked to 3 previously configured products on Stripe. By clicking on one of the buttons, the user will be directed to Stripe to finish payment. An AWS Lambda function listens to the events from Stripe via webhook. Once the payment finishes, Lambda will be notified to trigger Cognito to create a user account. A second Lambda is linked to Cognito for post confirmation trigger. Once the user finishes email verfication, the second Lambda writes the user information to DynamoDB database.
## DynamoDB Table Layout
The following graphs show the recommended schema for a single user table in DynamoDB. The schema can be created and edited via AWS CLI -> `add API` -> `GraphQL`.


![DB ER](https://user-images.githubusercontent.com/91907021/228631754-9b775b4c-ed92-4a73-ad21-8abf815b92a6.png)
![DB key-value pairs](https://user-images.githubusercontent.com/91907021/228632415-5fb531cd-634c-43c5-999c-9ccaa6e98ec0.jpg)


A template for the schema:
```
type User @model
  @auth(rules: [
    { allow: groups, groups: ["Admin"] },
    { allow: owner, ownerField: "username", operations: [read] }
  ]) {
  id: ID!
  username: String!
  email: String! 
}
```

## Link Stripe to Your App
- Create your React App and cd into the App folder
- Install packages: `npm i aws-amplify @stripe/stripe.js`
- Create 2 files that will be edited later: `SignIn.js` and `Subscribe.js`
- We will edit the Subscribe file first in the following section
### Get API Key from Stripe
- Create a Stripe account
- Create 3 products using the Stripe dashboard. Get your `Stripe Publishable Key` under "Get your API keys". In product details page, get each Product Key under `API ID` next to “price”.
### `Subscribe.js` Create Event Handlers and Buttons
- In `Subscribe.js`, import packages: `import { loadStripe } from '@stripe/stripe-js'`
- Create 3 event handlers with 3 buttons for each product in your Stripe account. When user clicks on one button, he/she will be redirected to the corresponding product on Stripe. Following is a template for one event handler:
```
const handleClick = async e => {
  const stripe = await loadStripe('your_stripe_publishable_key')
  const { error } = await stripe.redirectToCheckout({
    lineItems: [{
      price: 'price_key',
      quantity: 1
    }],
    mode: 'subscription',
    successUrl: 'http://localhost:3000/',
    cancelUrl: 'http://localhost:3000/cancel'
  })
}
```

- In each event handler, change the content in `loadStripe` to your `Stripe Publishable Key`. Change “price” to the 'API ID`. Make sure the `mode: subscription` is correct. Provide the link to your homepage for `successUrl` and your payment-canceled page to `cancelUrl`.
- Now `Subscribe.js` is finished. It is rendered in `App.js`.

## Create An Account Once Payment Is Completed
### Set up Amplify, Lambda, and Rest API in AWS CLI
- Using AWS CLI, initialize Amplify and add authentication services provided by Cognito
```
amplify init
amplify add auth
```
- Add an API and choose Rest API for the webhook we will use later: `amplify add api`
- Add a Lambda function. Give it access to `auth` and permit `create, read, update, delete` operations
- Configure the secret key to be accessed by Lambda function. It is the `secret key` of Stripe next to where you found your Publishable Key.
- `amplify push` to update the changes
### Write the Logic of Lambda Function
- `cd` into `src/` of your lambda backend folder
- Install packages: `npm i aws-sdk stripe`
- In `app.js`, the function for Lambda to retreive your Stripe API key is already provided
- Set up the Express service using the following code
```
const express = require('express')
const bodyParser = require('body-parser')
const awsServerlessExpressMiddleware = require('aws-serverless-express/middleware')
const aws = require('aws-sdk')

// declare a new express app
const app = express()
app.use(bodyParser.json({
  verify: function (req, res, buf) {
    req.rawBody = buf.toString()
  }
}))
app.use(awsServerlessExpressMiddleware.eventContext())
// Enable CORS for all methods
app.use(function (req, res, next) {
  res.header('Access-Control-Allow-Origin', '*')
  res.header('Access-Control-Allow-Headers', '*')
  next()
})

app.listen(3000, function () {
  console.log('App started')
})
```
### Write the Logic of Webhook and Cognito in Lambda
We will use webhook to "hook" Lambda and Stripe together. Once an event of successful payment is generated by Stripe, Stripe will send it to the hook address of Lambda. Lambda will be automatically triggered and parse the request body. Then, a user account will be created through Cognito adminAPI. We first set up the hook on the Lambda side. 
- In `app.js`, get your `userPoolId` in the comments
- Write a `post` functions that receives request body to webhook route
- In `post`, parse the user's information sent by Stripe
- In this code, we've used the withAuthenticator component. It will lay out an entire user authentication flow allowing users to sign up, sign in, reset their password, and confirm sign-in for multifactor authentication (MFA). We have also added a Sign Out button to log users out.
- A code template:
```
app.post('/webhook', async function (req, res) {
  const stripeKey = await getStripeKey()
  const stripe = require('stripe')(stripeKey)
  console.log(stripeKey)

  const customer = await stripe.customers.retrieve(
    req.body.data.object.customer
  )

  const userEmail = customer.email

function App({ signOut }) {
  return (
    <View className="App">
      <Card>
        <Image src={logo} className="App-logo" alt="logo" />
        <Heading level={1}>We now have Auth!</Heading>
      </Card>
      <Button onClick={signOut}>Sign Out</Button>
    </View>
  );
}
})
```
### Create the Webhook on Stripe
- Get the Url of your app. In `src/` -> `aws-exports.js`, find the `endpoint` key.
- Append the url string in the post function to the `endpoint` url. For example, `https.../webhook`
- In Stripe Dashboard, go to `Developers` -> `Webhooks` -> `+ Add Endpoint`, choose `payment_intent.succeeded` as the event to listen for, paste the entire url in last step

## Write User Data Into DynamoDB
- Add another Lambda function to the Amplify backend. It will serve as a trigger to write into DynamoDB after a user verifies his/her email during Cognito authentication.
- In Cognito (CLI or UI), link the Lambda function, and choose `PostConfirmationTrigger`.
- In `src/` -> `custom.js`, write an event handler function. It will take an incoming event from Cognito, parse the user info in the event, and write the parsed info into DynamoDB. 
- `Item` corresponds to one entry in the database and each item has attributes corresponding to the attributes in your GraphQL schema.
- Following is an example code template:
```
var aws = require('aws-sdk')
var ddb = new aws.DynamoDB()

exports.handler = async (event, context) => {
    let date = new Date()
    if (event.request.userAttributes.sub) {
        let params = {
            Item: {
                'id': {S: event.request.userAttributes.sub},
                '__typename': {S: 'User'},
                'username': {S: event.userName},
                'email': {S: event.request.userAttributes.email},
                'createdAt': {S: date.toISOString()},
                'updatedAt': {S: date.toISOString()},
            },
            TableName: process.env.USERTABLE
        }

        try {
            await ddb.putItem(params).promise()
            console.log("Success")
        } catch (err) {
            console.log("Error", err)
        }

        console.log("Success: Everything executed correctly")
        context.done(null, event)

    } else {
        console.log("Error: Nothing was written to DynamoDB")
        context.done(null, event)
    }
};
```
## SignIn and Render Paywalled Content
This is the last step. We have finished subscription and registration, now users can sign in and view subscription-exclusive contents.
- In `SignIn.js` that you created before, use Cognito's signIn function and create a simple signin form with userName and password.
- In `app.js`, add the Subscribe and SignIn component. Make sure the paywalled content is only shown after subscription.
- A code template:
```
function App () {
  const [user, setUser] = useState(null)
  return (
    <div className='App'>
      <h1>My Fancy Subscription Site</h1>
      <Subscribe />
      {user
        ? <h1>Paywalled content!</h1>
        : <SignIn setUser={setUser} />}
    </div>
  )
}
```

## Updating...
- 14-day Free Trial for the subscription
- Paywalled content: candidate search via ElasticSearch 

## Helpful Resources
[1] https://www.youtube.com/watch?v=Sk9HMuAaTmQ
[2] https://welearncode.com/stripe-amplify/
[3] https://aws.amazon.com/getting-started/hands-on/build-react-app-amplify-graphql/module-three/
[4] https://dzone.com/articles/from-aws-cognito-to-dynamobd-using-triggers
